#!/bin/bash
set -o nounset -o errexit -o pipefail

function take-extension() {
    echo "$1" | sed 's/.*\.//'
}

function drop-extension() {
    echo "$1" | sed 's/\.[^.]*$//'
}

function uppercase() {
    tr '[:lower:]' '[:upper:]'
}

function get-exif-date() {
    local FORMAT="$1"
    local INPUT_FILE="$2"
    exiv2 -g 'Exif.Photo.DateTimeOriginal' -Pv "$INPUT_FILE" |
        cut -d' ' -f1 |
        xargs date -j -f'%Y:%m:%d' "$FORMAT"
}

function get-exif-title() {
    local INPUT_FILE="$1"
    exiv2 -g 'Exif.Photo.UserComment' -Pt "$INPUT_FILE"
}

function main() {
    local INPUT_FILE="$1"
    local OUTPUT_FILE="$(drop-extension "$INPUT_FILE").jpg"
    local EXV_FILE="$(drop-extension "$INPUT_FILE").exv"
    local FONT="/System/Library/Fonts/Helvetica.dfont" # Or convert -list font
    local TITLE="$(get-exif-title "$INPUT_FILE" | uppercase)"
    local DATE="$(get-exif-date '+%B %Y' "$INPUT_FILE" | uppercase)"

    # Check title
    if [[ "$TITLE" = "" ]]; then
        echo "Missing title in user-comment field"
        exit 1
    fi

    # Check extension
    if [[ "$(take-extension "$INPUT_FILE")" != "tif" ]]; then
        echo "Input file should be a TIF"
        exit 1
    fi

    # Remove XMP packet and preview from input file
    exiv2 -d xt "$INPUT_FILE"

    # Dump EXIF to "$INPUT_FILE".exv
    exiv2 ex "$INPUT_FILE"
    if [[ ! -f "$EXV_FILE" ]]; then
        echo "EXIF export failed: $EXV_FILE not found"
        exit 1
    fi

    # Convert from TIFF to JPEG, add border and watermark
    convert                                      \
        -background black                        \
        -gravity North                           \
        -splice  0x20                            \
        -bordercolor black                       \
        -border 10                               \
        -fill '#aaaaaa'                          \
        -pointsize 20                            \
        -font "$FONT"                            \
        -gravity NorthWest                       \
        -draw "text 10,6 'JASPER VAN DER JEUGT'" \
        -gravity North                           \
        -draw "text 10,6 '$TITLE'"               \
        -gravity NorthEast                       \
        -draw "text 10,6 '$DATE'"                \
        -quality 98                              \
        "$INPUT_FILE"                            \
        "$OUTPUT_FILE"

    # Import EXIF from "$INPUT_FILE.exv"
    exiv2 in "$OUTPUT_FILE"

    # Clean up
    rm "$EXV_FILE"
}

# Check number of arguments
if [[ $# != 1 ]]; then
    echo "Usage: $0 picture.tif"
    echo "The user-comment exiv2 field must be set to the title."
    exit 1
fi

main "$1"
